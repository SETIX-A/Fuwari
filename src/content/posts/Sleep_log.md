---
title: Obsidian ç¡çœ è‡ªåŠ¨åŒ–ç»ˆææŒ‡å—ï¼šä¸€é”®è¿½è¸ªä¸å¯è§†åŒ–
published: 2025-08-25
description: ä¸€ç¯‡ç®€å•çš„ Markdown åšå®¢æ–‡ç« ç¤ºä¾‹ã€‚
tags:
  - Obsidian
  - æ¼”ç¤º
category: Obsidian
draft: false
---
å¤§å®¶å¥½ï¼æˆ‘æ˜¯ç¬¬ä¸€æ¬¡å†™åšå®¢çš„æ–°æ‰‹ï¼Œå¦‚æœä½ åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ä¸ºè®°å½•ç¡çœ æ—¶é—´è€Œçƒ¦æ¼â€”â€”æ¯å¤©æ‰‹åŠ¨è¾“å…¥æ•°æ®ã€è®¡ç®—æ—¶é•¿ï¼Œè¿˜å¾—æ‰‹åŠ¨ç»˜åˆ¶å›¾è¡¨â€”â€”é‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±æ˜¯ä¸ºä½ é‡èº«æ‰“é€ çš„ã€‚æˆ‘æ›¾ç»èŠ±äº†æ•´æ•´6ä¸ªå°æ—¶è°ƒè¯•å„ç§å‘ï¼Œæœ€ç»ˆæ­å»ºå‡ºä¸€å¥—å…¨è‡ªåŠ¨çš„Obsidianç¡çœ è¿½è¸ªç³»ç»Ÿã€‚ç°åœ¨ï¼Œæˆ‘å°†ä¸€æ­¥æ­¥å¸¦ä½ ä»é›¶å®ç°å®ƒï¼Œåªéœ€15åˆ†é’Ÿï¼Œä½ å°±èƒ½äº«å—åˆ°â€œä¸€é”®ç¡è§‰ã€ä¸€é”®èµ·åºŠâ€çš„æè‡´ä¾¿åˆ©ï¼Œä»¥åŠè‡ªåŠ¨ç”Ÿæˆçš„ç¡çœ æ•°æ®å¯è§†åŒ–å›¾è¡¨ã€‚

ä¸ºä»€ä¹ˆé€‰æ‹©Obsidianï¼Ÿå®ƒå…è´¹ã€å¼€æºã€æ”¯æŒæ’ä»¶æ‰©å±•ï¼Œèƒ½å°†ç¬”è®°è½¬åŒ–ä¸ºå¼ºå¤§çš„æ•°æ®ç®¡ç†ç³»ç»Ÿã€‚è·Ÿéšæˆ‘çš„æŒ‡å—ï¼Œä½ å°†å­¦ä¼šå¦‚ä½•ç”¨æ’ä»¶è‡ªåŠ¨åŒ–è®°å½•ç¡çœ ï¼Œå¹¶é€šè¿‡å›¾è¡¨æ´å¯Ÿä½ çš„ä½œæ¯ä¹ æƒ¯ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å§ï¼

## æœ€ç»ˆæ•ˆæœé¢„è§ˆ

æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼š
1. **æ™šä¸Šå‡†å¤‡ç¡è§‰æ—¶**ï¼šæŒ‰ä¸€ä¸ªå¿«æ·é”®ï¼Œç³»ç»Ÿè‡ªåŠ¨åœ¨ä½ çš„ç¡çœ æ—¥è®°ä¸­æ·»åŠ ä¸€è¡Œè®°å½•ï¼Œå¦‚ `- [date:: 2025-08-24], [bed:: 23:58], [wake:: ]`ã€‚å®ƒç”šè‡³èƒ½æ™ºèƒ½åˆ¤æ–­å‡Œæ™¨ç¡è§‰ï¼ˆä¾‹å¦‚å‡Œæ™¨3ç‚¹ï¼‰ï¼Œå¹¶å°†æ—¥æœŸå½’ä¸ºå‰ä¸€å¤©ã€‚
2. **æ—©ä¸Šèµ·åºŠæ—¶**ï¼šæŒ‰å¦ä¸€ä¸ªå¿«æ·é”®ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‰¾åˆ°æ˜¨æ™šçš„æœªå®Œæˆè®°å½•ï¼Œè¡¥å…¨èµ·åºŠæ—¶é—´ï¼Œå¹¶è®¡ç®—ç¡çœ æ—¶é•¿ï¼Œå¦‚ `- [date:: 2025-08-24], [bed:: 23:58], [wake:: 08:15], [duration:: 08:17]`ã€‚
3. **æ•°æ®å¯è§†åŒ–**ï¼šåœ¨ä»»æ„ç¬”è®°ä¸­æ’å…¥ä¸€æ®µä»£ç ï¼Œå°±èƒ½ç”Ÿæˆç¡çœ æ—¶é•¿è¶‹åŠ¿å›¾ã€å¹³å‡å…¥ç¡/èµ·åºŠæ—¶é—´åˆ†å¸ƒå›¾ï¼Œä»¥åŠæŒ‰æœˆ/å¹´ç»Ÿè®¡è¡¨æ ¼ã€‚æ‰€æœ‰æ•°æ®å®æ—¶æ›´æ–°ï¼Œä¸€ç›®äº†ç„¶ã€‚

è¿™ä¸ä»…ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯å¸®åŠ©ä½ ä¼˜åŒ–ç¡çœ ã€æå‡ç”Ÿæ´»è´¨é‡çš„å·¥å…·ã€‚

:::tip[æ³¨æ„]
**ä»¥ä¸‹æ˜¯æ¼”ç¤ºå›¾**
:::
![ç¤ºä¾‹å›¾ç‰‡](src/assets/images/sleep-1.jpeg "IOSé¢„è§ˆå¦‚ä¸‹")

## æ‰€éœ€å·¥å…·

- **[Obsidian](https://obsidian.md/)**ï¼ˆå…è´¹ä¸‹è½½è‡ªå®˜ç½‘ï¼‰ã€‚
- **æ’ä»¶**ï¼ˆåœ¨Obsidianè®¾ç½® > ç¤¾åŒºæ’ä»¶ä¸­å®‰è£…å¹¶å¯ç”¨ï¼‰ï¼š
  - **Templater**ï¼šæ ¸å¿ƒæ’ä»¶ï¼Œç”¨äºè¿è¡ŒJavaScriptè„šæœ¬ï¼Œå®ç°è‡ªåŠ¨åŒ–è®°å½•å’Œå¿«æ·å‘½ä»¤ã€‚
  - **Dataview**ï¼šç”¨äºæŸ¥è¯¢æ•°æ®å¹¶ç”Ÿæˆå›¾è¡¨ï¼Œæ”¯æŒåŠ¨æ€å¯è§†åŒ–ã€‚

å®‰è£…æ’ä»¶åï¼Œé‡å¯Obsidianä»¥ç¡®ä¿ç”Ÿæ•ˆã€‚å¦‚æœä½ ç”¨çš„æ˜¯ç§»åŠ¨ç«¯ï¼Œç¡®ä¿æ’ä»¶å…¼å®¹ã€‚

## Part 1: é…ç½®Templateræ¨¡æ¿â€”â€”è‡ªåŠ¨åŒ–è®°å½•çš„æ ¸å¿ƒè„šæœ¬

Templateræ’ä»¶å…è®¸æˆ‘ä»¬åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨JavaScriptä»£ç ï¼Œå®ç°åŠ¨æ€é€»è¾‘ã€‚é¦–å…ˆï¼Œåœ¨Obsidianè®¾ç½®ä¸­é…ç½®Templaterçš„æ¨¡æ¿æ–‡ä»¶å¤¹ï¼ˆä¾‹å¦‚åˆ›å»ºä¸€ä¸ªåä¸ºâ€œTemplatesâ€çš„æ–‡ä»¶å¤¹ï¼Œè·¯å¾„ä¸ºâ€œTemplates/â€ï¼‰ã€‚

### æ¨¡æ¿1ï¼šè®°å½•ç¡è§‰æ—¶é—´ï¼ˆbed.mdï¼‰

è¿™ä¸ªæ¨¡æ¿è´Ÿè´£æ–°å»ºç¡çœ è®°å½•ã€‚å®ƒä¼šè‡ªåŠ¨å¤„ç†å‡Œæ™¨åœºæ™¯ï¼Œç¡®ä¿æ—¥æœŸæ­£ç¡®ã€‚

åœ¨â€œTemplatesâ€æ–‡ä»¶å¤¹ä¸‹åˆ›å»º`bed.md`æ–‡ä»¶ï¼Œç²˜è´´ä»¥ä¸‹ä»£ç ï¼š
```javascript
<%*
// --- é…ç½®åŒº ---
const sleepLogFile = "ç¡çœ æ—¥è®°-2025.md"; // ä½ çš„ç¡çœ æ—¥å¿—è·¯å¾„ï¼ˆå¯è‡ªå®šä¹‰æ–‡ä»¶å¤¹ï¼Œå¦‚"è®°å½•/ç¡çœ æ—¥è®°-2025.md"ï¼‰
// --- ç»“æŸé…ç½® ---

const now = tp.date.now();
const hour = parseInt(tp.date.now("H"));

// å…³é”®é€»è¾‘ï¼šå¦‚æœåœ¨å‡Œæ™¨5ç‚¹å‰è®°å½•ï¼Œæ—¥æœŸè‡ªåŠ¨ç®—ä½œå‰ä¸€å¤©
const dateString = (hour < 5) ? tp.date.now("YYYY-MM-DD", -1) : tp.date.now("YYYY-MM-DD");
const bedTime = tp.date.now("HH:mm");

// \nç¡®ä¿æ€»æ˜¯åœ¨æ–°çš„ä¸€è¡Œæ·»åŠ 
const newEntry = `\n- [date:: ${dateString}], [bed:: ${bedTime}], [wake:: ]`;

const file = tp.file.find_tfile(sleepLogFile);
if (!file) {
    new Notice(`âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ "${sleepLogFile}"`, 5000);
    return;
}

await tp.app.vault.append(file, newEntry);
new Notice(`ğŸ›Œ å·²è®°å½•ç¡è§‰æ—¶é—´: ${bedTime}`, 3000);
%>
```

### æ¨¡æ¿2ï¼šè®°å½•èµ·åºŠæ—¶é—´ï¼ˆwake.mdï¼‰

è¿™ä¸ªæ¨¡æ¿ä¼šæ‰«ææ—¥å¿—æ–‡ä»¶ï¼Œæ‰¾åˆ°æœ€åä¸€æ¡æœªå®Œæˆçš„è®°å½•ï¼Œè¡¥å…¨èµ·åºŠæ—¶é—´å¹¶è®¡ç®—æ—¶é•¿ã€‚

åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹åˆ›å»º`wake.md`æ–‡ä»¶ï¼Œç²˜è´´ä»¥ä¸‹ä»£ç ï¼š

```javascript
<%*
// ä½¿ç”¨ä¸€ä¸ªç«‹å³æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•° (IIFE) æ¥ç¡®ä¿ä»£ç çš„ç¨³å®šæ€§å’Œä½œç”¨åŸŸéš”ç¦»
(async () => {
    // --- é…ç½® ---
    const filePath = 'ç¡çœ æ—¥è®°-2025.md'; // ä½ çš„ç¡çœ æ—¥å¿—æ–‡ä»¶å
    const morningCutoffHour = 5; // æ—©ä¸Šå‡ ç‚¹å‰ç¡è§‰ï¼Œä»ç®—ä½œå‰ä¸€å¤©çš„ç¡çœ å‘¨æœŸ
    // --- ç»“æŸé…ç½® ---
    const file = this.app.vault.getAbstractFileByPath(filePath);
    if (!file) {
        new Notice(`é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ ${filePath}`, 5000);
        return;
    }
    try {
        const content = await this.app.vault.read(file);
        const lines = content.split('\n');
        let updated = false;
        for (let i = lines.length - 1; i >= 0; i--) {
            let line = lines[i];
            if (line.includes('[bed::') && line.includes('[wake:: ]')) {
                const match = line.match(/\[date:: (.*?)\].*\[bed:: (.*?)\]/);

                if (match && match[1] && match[2]) {
                    const dateStr = match[1]; // è¿™æ˜¯ç¡çœ å½’å±çš„æ—¥æœŸ, e.g., "2025-08-23"
                    const bedTimeStr = match[2]; // e.g., "02:57"
                    
                    // --- æ ¸å¿ƒæ™ºèƒ½é€»è¾‘å¼€å§‹ ---
                    const bedHour = parseInt(bedTimeStr.split(':')[0], 10);
                    const bedDateAnchor = moment(dateStr); // è·å–ç¡çœ å½’å±æ—¥æœŸ
                    // å¦‚æœç¡è§‰æ—¶é—´åœ¨å‡Œæ™¨ï¼Œé‚£ä¹ˆå®ƒçš„å®é™…æ—¥å†æ—¥æœŸæ˜¯â€œå½’å±æ—¥æœŸâ€çš„åä¸€å¤©
                    if (bedHour < morningCutoffHour) {
                        bedDateAnchor.add(1, 'day');
                    }
                    
                    // æ„å»ºå‡ºçœŸå®çš„ç¡è§‰æ—¶é—´æˆ³
                    const bedMoment = moment(`${bedDateAnchor.format('YYYY-MM-DD')} ${bedTimeStr}`);
                    // --- æ ¸å¿ƒæ™ºèƒ½é€»è¾‘ç»“æŸ ---
                    const wakeMoment = moment(); // è·å–çœŸå®çš„èµ·åºŠæ—¶é—´æˆ³
                    
                    const duration = moment.duration(wakeMoment.diff(bedMoment));
                    const hours = Math.floor(duration.asHours());
                    const minutes = duration.minutes();
                    
                    const wakeTimeFormatted = wakeMoment.format('HH:mm');
                    const durationFormatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    
                    const updatedLine = line.replace(
                        '[wake:: ]', 
                        `[wake:: ${wakeTimeFormatted}], [duration:: ${durationFormatted}]`
                    );
                    
                    lines[i] = updatedLine;
                    updated = true;

                    new Notice(`èµ·åºŠæˆåŠŸï¼ğŸ‰\nç¡çœ æ—¶é•¿: ${hours} å°æ—¶ ${minutes} åˆ†é’Ÿ`, 6000);//è‡ªå®šä¹‰å¼¹å‡ºä¿¡æ¯
                    break; 
                }
            }
        }
        if (updated) {
            const newContent = lines.join('\n');
            await this.app.vault.modify(file, newContent);
        } else {
            new Notice('æœªæ‰¾åˆ°éœ€è¦æ›´æ–°çš„ç¡çœ è®°å½•ã€‚', 5000);
        }
    } catch (error) {
        console.error("Templater è„šæœ¬ 'tpl-sleep-wake' å‡ºç°é”™è¯¯:", error);
        new Notice("è®°å½•èµ·åºŠå¤±è´¥ï¼Œè¯·æ£€æŸ¥å¼€å‘è€…æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚", 10000);
    }
})();
%>
```

**æç¤º**ï¼šè¿™äº›è„šæœ¬ä¾èµ–`moment.js`ï¼ˆTemplaterå†…ç½®æ”¯æŒï¼‰ã€‚æµ‹è¯•æ—¶ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„`ç¡çœ æ—¥è®°-2025.md`æ–‡ä»¶ï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®ã€‚

### æ¨¡æ¿3ï¼šè®°å½•ç¡è§‰æ—¥å¿—ï¼ˆç¡çœ æ—¥è®°-2025.mdï¼‰

````
```dataviewjs
const sleepFile = "";
const displayCount = 4; // å®šä¹‰æ˜¾ç¤ºçš„è¡Œæ•°ï¼Œå¯ä»»æ„ä¿®æ”¹ï¼
const page = dv.page(sleepFile);

if (page && page.file && page.file.lists && page.file.lists.length > 0) {
    const recordCount = page.file.lists.length;
    // è¾“å‡ºæ€»è®°å½•æ•°
    dv.paragraph(`ğŸ›Œ ç¡çœ è®°å½•å…±æœ‰ **${recordCount}** æ¡æ•°æ®`);
    
    // è·å–æœ€å displayCount æ¡è®°å½•
    const recentRecords = page.file.lists.slice(-displayCount);
    
    // è¾“å‡ºæœ€è¿‘çš„è®°å½•
    dv.header(3, "æœ€è¿‘è®°å½•"); // æ ‡é¢˜ï¼Œçº§åˆ«3ï¼ˆ###ï¼‰
    dv.list(recentRecords.map(item => item.text)); // åˆ—å‡ºæ¯æ¡è®°å½•çš„æ–‡æœ¬å†…å®¹
} else {
    dv.paragraph("âŒ æœªæ‰¾åˆ°ç¡çœ è®°å½•æ•°æ®æˆ–è®°å½•ä¸ºç©º");
}
```

- [date:: 2025-08-01] [bed:: 23:30] [wake:: 09:50]ï¼ˆè¿™æ˜¯æ ¼å¼ç¤ºä¾‹ï¼Œä½ ä¸ç”¨æ‰‹åŠ¨è¾“å…¥æ ¼å¼ï¼Œæ‰€æœ‰çš„æ­¥éª¤éƒ½æ˜¯è‡ªåŠ¨çš„ï¼‰

````

:::caution[é‡è¦äº‹é¡¹]
è¿™ä¸ªæ¨¡æ¿æ˜¯æœ€æ ¸å¿ƒçš„è®°å½•æ—¥å¿—çš„ç¬”è®°ï¼Œå®ƒç›´æ¥å…³ç³»åˆ°[æ¨¡æ¿1](#æ¨¡æ¿1è®°å½•ç¡è§‰æ—¶é—´bedmd)ä¸[æ¨¡æ¿2](#æ¨¡æ¿2è®°å½•èµ·åºŠæ—¶é—´wakemd)çš„æ•°æ®æ±‡æ€»ã€‚åŒæ—¶ä¹Ÿæ˜¯[ç¡çœ ç»Ÿè®¡æŠ¥å‘Š](#part-3-æ•°æ®å¯è§†åŒ–ç”¨dataviewç”Ÿæˆå›¾è¡¨)çš„é»˜è®¤è·¯å¾„ï¼Œæˆ‘è¿™é‡Œè®¾ç½®çš„è·¯å¾„æ˜¯æ ¹ç›®å½•ï¼Œå€˜è‹¥ä½ å°†å…¶æ”¾åœ¨åä¸ºâ€œè®°å½•â€çš„æ–‡ä»¶å¤¹é‡Œï¼Œè¯·å°†è¿™3ä¸ªä»£ç æœ€é¡¶éƒ¨çš„è·¯å¾„**åŒæ­¥æ›´æ”¹**ä¸ºâ€œè®°å½•/ç¡çœ æ—¥è®°-2025.mdâ€œï¼Œ[æ¨¡æ¿3](#æ¨¡æ¿3è®°å½•ç¡è§‰æ—¥å¿—ç¡çœ æ—¥è®°-2025md)ä¸éœ€è¦ä¸éœ€è¦æ·»åŠ è·¯å¾„ï¼Œè¯·å°†æ¨¡æ¿3çš„**ç¬”è®°å‘½åä¸ºâ€œç¡çœ æ—¥è®°-2025â€**ï¼ˆè¿™å¾ˆé‡è¦ï¼‰ã€‚å¦‚æœä½ ä¸å–œæ¬¢è¿™ä¸ªåå­—ï¼Œä¹Ÿè¯·å°†3ä¸ªæ¨¡æ¿è¿›è¡ŒåŒæ­¥æ›´æ”¹ã€‚
:::

---
## Part 2: é…ç½®å¿«æ·å‘½ä»¤â€”â€”ä¸€é”®è§¦å‘è‡ªåŠ¨åŒ–

ç°åœ¨ï¼Œè®©è¿™äº›æ¨¡æ¿å˜å¾—æ˜“ç”¨ã€‚é€šè¿‡Templaterçš„â€œTemplate Hotkeysâ€åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨¡æ¿ç»‘å®šåˆ°å‘½ä»¤é¢æ¿æˆ–çƒ­é”®ã€‚

1. **è®¾ç½®Templateræ¨¡æ¿æ–‡ä»¶å¤¹**ï¼š
   - æ‰“å¼€Obsidianè®¾ç½® > ç¤¾åŒºæ’ä»¶ > Templaterã€‚
   - åœ¨â€œTemplate folder locationâ€ä¸­è¾“å…¥ä½ çš„æ¨¡æ¿æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¦‚â€œTemplates/â€ï¼‰ã€‚

2. **æ·»åŠ ä¸“ç”¨å‘½ä»¤**ï¼ˆæ¨èï¼Œè®©æ¨¡æ¿ç›´æ¥å‡ºç°åœ¨å‘½ä»¤é¢æ¿ï¼‰ï¼š
   - åœ¨Templaterè®¾ç½®ä¸­ï¼Œæ»šåŠ¨åˆ°â€œTemplate Hotkeysâ€ã€‚
   - ç‚¹å‡»â€œAdd newâ€ï¼Œé€‰æ‹©æ¨¡æ¿æ–‡ä»¶ï¼ˆå¦‚`bed.md`ï¼‰ï¼Œçƒ­é”®å¯é€‰ç•™ç©ºã€‚
   - é‡å¤ä¸º`wake.md`æ·»åŠ ã€‚
   - ç°åœ¨ï¼ŒæŒ‰Ctrl+Pï¼ˆæˆ–Cmd+Pï¼‰æ‰“å¼€å‘½ä»¤é¢æ¿ï¼Œæœç´¢â€œTemplater: Insert bedâ€æˆ–ç±»ä¼¼ï¼Œå³å¯ä¸€é”®è¿è¡Œã€‚

**å¯é€‰**ï¼šä¸ºå‘½ä»¤åˆ†é…çƒ­é”®ï¼ˆå¦‚Ctrl+Alt+B for bedï¼‰ï¼Œå®ç°çœŸæ­£çš„ä¸€é”®æ“ä½œã€‚

:::tip[æç¤º]
å€˜è‹¥ä½ å·²æˆåŠŸå®Œæˆtemplatesçš„åŸºç¡€é…ç½®ï¼Œä½ çš„å‘½ä»¤é¢æ¿åº”è¯¥æ˜¯è¿™æ ·çš„ï¼ˆä½ å¯ä»¥å‰å¾€â€œè®¾ç½®â€ï¼Œåœ¨â€å‘½åé¢æ¿â€œæœç´¢åä¸ºâ€bedâ€œçš„å‘½ä»¤å¹¶å°†å…¶ç½®é¡¶ã€‚
:::

![ç¤ºä¾‹å›¾ç‰‡](src/assets/images/sleep-2.jpg "å‘½ä»¤é¢æ¿")

## Part 3: æ•°æ®å¯è§†åŒ–â€”â€”ç”¨Dataviewç”Ÿæˆå›¾è¡¨

æœ€åä¸€æ­¥ï¼šè®©æ•°æ®â€œæ´»â€èµ·æ¥ï¼åœ¨ä»»ä½•ç¬”è®°ä¸­æ’å…¥ä»¥ä¸‹DataviewJSä»£ç å—ï¼Œå®ƒä¼šè‡ªåŠ¨åŠ è½½Chart.jsåº“ï¼Œç”Ÿæˆå¤šç§å›¾è¡¨å’Œç»Ÿè®¡ã€‚

<details>
<summary style="color: pink;">ç‚¹å‡»æŸ¥çœ‹/æŠ˜å ç¡çœ æŠ¥å‘Š Dataviewjs</summary>

&#x60;&#x60;&#x60;

````
```dataviewjs
// --- é…ç½® ---
const FILE_PATH = "6-è®°å½•/ç¡çœ /ç¡çœ æ—¥è®°-2025.md";
// --- é…ç½®ç»“æŸ ---

// --- è¾…åŠ©å‡½æ•°ä¸å¸¸é‡ ---

// --- Dateï¼š25.08.29 ---

const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

const formatDurationFromMs = (ms) => {
    if (isNaN(ms) || ms < 0) return "æ— æ•ˆæ—¶é•¿";
    const totalMinutes = Math.round(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${hours}æ—¶ ${minutes}åˆ†`;
};

const formatAvgDurationHours = (ms) => {
    if (isNaN(ms) || ms < 0) return "æ— æ•ˆ";
    return (ms / (1000 * 60 * 60)).toFixed(2);
};

const groupBy = (data, keyFn) => {
    return data.reduce((acc, item) => {
        const key = keyFn(item);
        if (!acc[key]) acc[key] = [];
        acc[key].push(item);
        return acc;
    }, {});
};

const calculateAverages = (group) => {
    const total = group.length;
    if (total === 0) return null;
    const avgDurationMs = group.reduce((sum, r) => sum + r.durationMillis, 0) / total;

    const calculateMeanTime = (times) => {
        if (times.length === 0) return null;
        const radians = times.map(t => (t / 24) * 2 * Math.PI);
        const sinSum = radians.reduce((sum, r) => sum + Math.sin(r), 0) / times.length;
        const cosSum = radians.reduce((sum, r) => sum + Math.cos(r), 0) / times.length;
        let meanAngle = Math.atan2(sinSum, cosSum);
        if (meanAngle < 0) meanAngle += 2 * Math.PI;
        let meanHours = (meanAngle / (2 * Math.PI)) * 24;
        const hours = Math.floor(meanHours);
        const minutes = Math.round((meanHours - hours) * 60);
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    };

    return {
        "è®°å½•å¤©æ•°": total,
        "å¹³å‡å…¥ç¡": calculateMeanTime(group.filter(r => r.bedtimeHour !== undefined).map(r => r.bedtimeHour)),
        "å¹³å‡èµ·åºŠ": calculateMeanTime(group.filter(r => r.waketimeHour !== undefined).map(r => r.waketimeHour)),
        "å¹³å‡æ—¶é•¿": formatDurationFromMs(avgDurationMs),
        "avgDurationMs": avgDurationMs
    };
};

// ------------------------------------------------------------------
// --- 1. æ•°æ®è§£ææ¨¡å— ---
// ------------------------------------------------------------------

function parseSleepData(page) {
    if (!page || !page.file || !page.file.lists || page.file.lists.length === 0) {
        dv.paragraph("âŒ **é”™è¯¯ï¼š** æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–æ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®ã€‚");
        return null;
    }
    return page.file.lists
        .where(item => item.date && (item.duration || (item.bed && item.wake)))
        .map(item => {
            try {
                const dateStr = item.date.toString().substring(0, 10);
                let durationMillis, bedtimeHour, waketimeHour;

                if (item.duration) {
                    const [hours, minutes] = item.duration.toString().split(':').map(Number);
                    if (isNaN(hours) || isNaN(minutes)) return null;
                    durationMillis = (hours * 60 + minutes) * 60 * 1000;
                } else {
                    const bedtime = dv.date(`${dateStr}T${item.bed}`);
                    let waketime = dv.date(`${dateStr}T${item.wake}`);
                    if (!bedtime || !waketime) return null;
                    if (waketime <= bedtime) waketime = waketime.plus({ days: 1 });
                    durationMillis = waketime.toMillis() - bedtime.toMillis();
                }

                if (item.bed) {
                    const bedtime = dv.date(`${dateStr}T${item.bed}`);
                    if (bedtime) bedtimeHour = bedtime.hour + bedtime.minute / 60;
                }
                if (item.wake) {
                    const waketime = dv.date(`${dateStr}T${item.wake}`);
                    if (waketime) waketimeHour = waketime.hour + waketime.minute / 60;
                }

                return { date: dv.date(dateStr), durationMillis, bedtimeHour, waketimeHour };
            } catch (e) {
                console.warn(`[DataviewJS Sleep Report] è§£ææ•°æ®å¤±è´¥ï¼Œå·²è·³è¿‡æ­¤è¡Œ: ${item.text}`, e);
                return null;
            }
        })
        .filter(item => item !== null && !isNaN(item.durationMillis))
        .values;
}

// ------------------------------------------------------------------
// --- 2. æ ¸å¿ƒç»Ÿè®¡è®¡ç®—æ¨¡å— ---
// ------------------------------------------------------------------
function calculateAllStatistics(records) {
    const today = dv.date('now').startOf('day'); // è·å–ä»Šå¤©çš„æ—¥æœŸï¼Œä½†æ—¶é—´è®¾ä¸º 00:00:00
    const sevenDaysAgo = today.minus({ days: 7 }); 
    const thirtyDaysAgo = today.minus({ days: 30 }); 

    const stats = {
        recent7DaysRecords: [],
        recent30DaysRecords: [],
        byMonth: {},
        byYear: {},
        totalRecords: records.length,
    };

    for (const record of records) {
        const recordDate = record.date; 
        
        if (recordDate.ts >= thirtyDaysAgo.ts && recordDate.ts <= today.ts) {
            stats.recent30DaysRecords.push(record);
            if (recordDate.ts >= sevenDaysAgo.ts) {
                stats.recent7DaysRecords.push(record);
            }
        }
        
        const monthKey = recordDate.toFormat("yyyy-'å¹´' MM'-æœˆ'");
        if (!stats.byMonth[monthKey]) stats.byMonth[monthKey] = [];
        stats.byMonth[monthKey].push(record);

        const yearKey = recordDate.year;
        if (!stats.byYear[yearKey]) stats.byYear[yearKey] = [];
        stats.byYear[yearKey].push(record);
    }

    stats.sevenDayAvg = calculateAverages(stats.recent7DaysRecords);
    stats.thirtyDayAvg = calculateAverages(stats.recent30DaysRecords);
    
    stats.recent7DaysGrouped = groupBy(stats.recent7DaysRecords, r => r.date.toFormat("MM-dd"));
    stats.recent30DaysGrouped = groupBy(stats.recent30DaysRecords, r => r.date.toFormat("MM-dd"));

    stats.limitedMonthlyData = Object.fromEntries(Object.entries(stats.byMonth).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 12));
    stats.limitedYearlyData = Object.fromEntries(Object.entries(stats.byYear).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 12));

    return stats;
}

// ------------------------------------------------------------------
// --- 3. æŠ¥å‘Šæ¸²æŸ“æ¨¡å— ---
// ------------------------------------------------------------------

const calculateDistribution = (group, type) => {
    const hours = type === 'bedtime' ? group.map(r => r.bedtimeHour) : group.map(r => r.waketimeHour);
    const validHours = hours.filter(h => h !== undefined);
    const dist = {};
    validHours.forEach(h => {
        const bucket = `${String(Math.floor(h)).padStart(2, '0')}:00`;
        dist[bucket] = (dist[bucket] || 0) + 1;
    });
    return dist;
};

const renderTable = (header, data) => {
    const rows = Object.keys(data).sort((a, b) => b.localeCompare(a)).map(key => {
        const avg = calculateAverages(data[key]);
        return [avg.å¹³å‡æ—¶é•¿, avg.å¹³å‡å…¥ç¡ || "æ— æ•°æ®", avg.å¹³å‡èµ·åºŠ || "æ— æ•°æ®", key];
    });
    dv.table(["å¹³å‡æ—¶é•¿", "å¹³å‡å…¥ç¡", "å¹³å‡èµ·åºŠ", header], rows);
};

const createChartCanvas = () => {
    const canvas = dv.el("canvas");
    canvas.style.width = '100%';
    canvas.style.height = '300px';
    canvas.width = window.innerWidth * window.devicePixelRatio;
    canvas.height = 300 * window.devicePixelRatio;
    dv.container.appendChild(canvas);
    return canvas.getContext('2d');
};

const renderAvgChart = (data, title) => {
    const labels = Object.keys(data).sort((a, b) => a.localeCompare(b));
    const chartValues = labels.map(key => {
        const avg = calculateAverages(data[key]);
        return (avg.avgDurationMs / (1000 * 60 * 60)).toFixed(2);
    });
    const ctx = createChartCanvas();
    new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: `${title} å¹³å‡ç¡çœ æ—¶é•¿ (å°æ—¶)`, data: chartValues, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'å°æ—¶' } } }, animation: { duration: IS_IOS ? 0 : 1000 } } });
};

const renderTrendChart = (data, title, days) => {
    const labels = Object.keys(data).sort((a, b) => a.localeCompare(b));
    const chartValues = labels.map(key => formatAvgDurationHours(calculateAverages(data[key]).avgDurationMs));
    const ctx = createChartCanvas();
    new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: `${title} ç¡çœ æ—¶é•¿è¶‹åŠ¿ (å°æ—¶)`, data: chartValues, backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 2, fill: false, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'å°æ—¶' } } }, animation: { duration: IS_IOS ? 0 : 1000 } } });
};

const renderStackedDistChart = (data, title) => {
    const bedtimeDist = calculateDistribution(data, 'bedtime');
    const waketimeDist = calculateDistribution(data, 'waketime');
    const allLabels = [...new Set([...Object.keys(bedtimeDist), ...Object.keys(waketimeDist)])].sort();
    const ctx = createChartCanvas();
    new Chart(ctx, { type: 'bar', data: { labels: allLabels, datasets: [{ label: 'å…¥ç¡æ—¶é—´', data: allLabels.map(label => bedtimeDist[label] || 0), backgroundColor: 'rgba(54, 162, 235, 0.4)', stack: 'Stack 0' }, { label: 'èµ·åºŠæ—¶é—´', data: allLabels.map(label => waketimeDist[label] || 0), backgroundColor: 'rgba(75, 192, 192, 0.4)', stack: 'Stack 0' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, animation: { duration: IS_IOS ? 0 : 1000 } } });
};

function renderReport(stats) {
    if (stats.totalRecords === 0) {
        dv.paragraph("âœ… æ–‡ä»¶å·²æ‰¾åˆ°ï¼Œä½†æœªèƒ½è§£æå‡ºä»»ä½•æœ‰æ•ˆæ•°æ®è¡Œã€‚è¯·æ£€æŸ¥æ•°æ®æ ¼å¼ã€‚");
        return;
    }
    
    dv.header(4, `è¿‘7å¤©ç¡çœ è¶‹åŠ¿ å¹³å‡: ${stats.sevenDayAvg ? formatAvgDurationHours(stats.sevenDayAvg.avgDurationMs) : 'æ— æ•°æ®'}å°æ—¶`);
    renderTrendChart(stats.recent7DaysGrouped, "è¿‘7å¤©", 7);

    dv.header(4, `æœ€è¿‘30å¤©ç¡çœ æ—¶é•¿è¶‹åŠ¿ å¹³å‡: ${stats.thirtyDayAvg ? formatAvgDurationHours(stats.thirtyDayAvg.avgDurationMs) : 'æ— æ•°æ®'}å°æ—¶`);
    renderTrendChart(stats.recent30DaysGrouped, "æœ€è¿‘30å¤©", 30);
    dv.header(4, "æœ€è¿‘30å¤©å…¥ç¡/èµ·åºŠæ—¶é—´åˆ†å¸ƒ");
    renderStackedDistChart(stats.recent30DaysRecords, "æœ€è¿‘30å¤©");

    dv.header(3, "æŒ‰æœˆç»Ÿè®¡");
    renderTable("æœˆä»½", stats.limitedMonthlyData);
    renderAvgChart(stats.limitedMonthlyData, "æœˆ");

    dv.header(3, "æŒ‰å¹´ç»Ÿè®¡");
    renderTable("å¹´ä»½", stats.limitedYearlyData);
    renderAvgChart(stats.limitedYearlyData, "å¹´");

    dv.el('p', `ğŸ›Œ ç¡çœ è®°å½•å…± ${stats.totalRecords} æ¡`, { cls: 'sleep-record-count' });
}

// ------------------------------------------------------------------
// --- ä¸»æ‰§è¡Œé€»è¾‘ ---
// ------------------------------------------------------------------

const main = () => {
    const style = document.createElement('style');
    style.textContent = `
        .dataview.container { width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
        canvas { width: 100% !important; max-height: 350px !important; }
        .sleep-record-count { font-size: 0.8em; color: var(--text-muted); text-align: left; margin-top: 15px; }
        @media (max-width: 600px) { canvas { max-height: 300px !important; } }
    `;
    document.head.appendChild(style);

    const page = dv.page(FILE_PATH);
    const records = parseSleepData(page);

    if (records) {
        const statistics = calculateAllStatistics(records);
        renderReport(statistics);
    }
};

if (typeof Chart === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js';
    document.head.appendChild(script);
    script.onload = main;
    script.onerror = () => dv.paragraph("âŒ æ— æ³•åŠ è½½ Chart.js åº“ï¼Œå›¾è¡¨æ— æ³•æ˜¾ç¤ºã€‚");
} else {
    main();
}
```
````

&#x60;&#x60;&#x60;

</details>

**æç¤º**ï¼šä»£ç ä¼šä»CDNåŠ è½½Chart.jsï¼Œç¡®ä¿ä½ çš„Obsidianæœ‰ç½‘ç»œæƒé™ã€‚å¦‚æœå›¾è¡¨ä¸æ˜¾ç¤ºï¼Œæ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæ•°æ®æ ¼å¼ã€‚

## ç»“è¯­

æ­å–œï¼ä½ ç°åœ¨æ‹¥æœ‰äº†ä¸€å¥—å®Œæ•´çš„Obsidianç¡çœ è‡ªåŠ¨åŒ–ç³»ç»Ÿã€‚ä»æ‰‹åŠ¨è®°å½•çš„çƒ¦æ¼ï¼Œåˆ°ä¸€é”®æ“ä½œå’Œæ™ºèƒ½å›¾è¡¨çš„ä¾¿åˆ©ï¼Œè¿™ä¸ä»…ä»…æ˜¯å·¥å…·ï¼Œæ›´æ˜¯ç”Ÿæ´»ä¼˜åŒ–çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘çš„6å°æ—¶è°ƒè¯•ç»å†ï¼Œå°±æ˜¯ä¸ºäº†è®©ä½ é¿å¼€æ‰€æœ‰å‘ï¼Œç›´æ¥ä¸Šæ‰‹ã€‚å¦‚æœä½ é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµâ€”â€”æˆ–è®¸æˆ‘ä»¬èƒ½ä¸€èµ·å®Œå–„å®ƒã€‚

ä½œä¸ºæ–°æ‰‹åšä¸»ï¼Œæˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©æ›´å¤šäººã€‚å¦‚æœä½ å–œæ¬¢ï¼Œåˆ†äº«ç»™æœ‹å‹å§ï¼æœªæ¥ï¼Œæˆ‘è®¡åˆ’å½•åˆ¶è§†é¢‘æ•™ç¨‹ï¼Œè¿›ä¸€æ­¥ä¼ æ’­è¿™ä¸ªideaã€‚

:::note[âœ¨ â€‹**ä½¿ç”¨æç¤º**â€‹ âœ¨]

> ä»¥ä¸Šä»£ç æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æœ¬åœ°åŒ–æ•°æ®æŸ¥è¯¢ï¼Œæ‰€æœ‰æ•°æ®å¤„ç†éƒ½åœ¨ä½ è‡ªå·±çš„è®¾å¤‡ä¸Šå®Œæˆã€‚
> 
> â€‹**æœ€å…³é”®çš„ä¸€ç‚¹ï¼šå®ƒä¸ä¼šå°†ä½ çš„ä»»ä½•æ•°æ®ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼â€‹**â€‹

å¦‚æœä½ é‡åˆ°äº†ç¨‹åºé”™è¯¯ï¼Œæˆ–è€…çµå…‰ä¸€ç°æœ‰äº†è¶…æ£’çš„æƒ³æ³•ï¼Œéšæ—¶æ¬¢è¿å‘Šè¯‰æˆ‘ï¼

ğŸ“§ é‚®ä»¶ï¼š[Socrates.02zx@Gmail.com](mailto:Socrates.02zx@Gmail.com)

æ„Ÿè°¢é˜…è¯»ï¼Œä¸‹æ¬¡è§ï¼:)
:::